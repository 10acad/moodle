define(["jquery","core/ajax","core/templates","core/notification","core/config","core/url","core/str"],function(a,b,c,d,e,f,g){var h=3,i=30,j=4,k=40,l={recordvote:function(g,h,i,j){var k=a(j.target).closest(".moodleoverflowpost").prev(),l=k.attr("id");l=l.substring(1);var m=b.call([{methodname:"mod_moodleoverflow_record_vote",args:{discussionid:g,postid:l,ratingid:h,sesskey:e.sesskey}}]);return m[0].done(function(b){var d=a(j.target).parent().parent();2===h?(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvoted","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvote","moodleoverflow"))):1===h?(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvoted","moodleoverflow"))):(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvote","moodleoverflow"))),d.children("p").text(b.postrating),c.replaceNode(a(".user-details,.author").find('a[href*="id='+i+'"]').siblings("span"),"<span>"+b.raterreputation+"</span>",""),i!==b.ownerid&&c.replaceNode(a(".user-details,.author").find('a[href*="id='+b.ownerid+'"]').siblings("span"),"<span>"+b.ownerreputation+"</span>","")}).fail(d.exception),m},clickevent:function(b,c){a(".upvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?l.recordvote(b,20,c,d):l.recordvote(b,2,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().nextAll("a").removeClass("active")}),a(".downvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?l.recordvote(b,10,c,d):l.recordvote(b,1,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().prevAll("a").removeClass("active")}),a(".marksolved").on("click",function(d){var e=a(d.target).parents(".moodleoverflowpost");e.hasClass("statusteacher")||e.hasClass("statusboth")?l.recordvote(b,i,c,d)[0].then(function(){l.removeSolvedFromPost(e)}):l.recordvote(b,h,c,d)[0].then(function(){l.removeOtherSolved(e.parent().parent()),e.hasClass("statusstarter")?(e.removeClass("statusstarter"),e.addClass("statusboth")):e.addClass("statusteacher");var b=g.get_string("marknotsolved","mod_moodleoverflow");a.when(b).done(function(b){a(d.target).text(b)}),l.redoStatus(e)})}),a(".markhelpful").on("click",function(d){var e=a(d.target).parents(".moodleoverflowpost");e.hasClass("statusstarter")||e.hasClass("statusboth")?l.recordvote(b,k,c,d)[0].then(function(){l.removeHelpfulFromPost(e)}):l.recordvote(b,j,c,d)[0].then(function(){l.removeOtherHelpful(e.parent().parent()),e.hasClass("statusteacher")?(e.removeClass("statusteacher"),e.addClass("statusboth")):e.addClass("statusstarter");var b=g.get_string("marknothelpful","mod_moodleoverflow");a.when(b).done(function(b){a(d.target).text(b)}),l.redoStatus(e)})})},removeHelpfulFromPost:function(b){b.hasClass("statusstarter")?b.removeClass("statusstarter"):(b.removeClass("statusboth"),b.addClass("statusteacher")),l.redoStatus(b);var c=g.get_string("markhelpful","mod_moodleoverflow");a.when(c).done(function(a){b.find(".markhelpful").text(a)})},removeOtherHelpful:function(a){var b=a.find(".statusstarter, .statusboth");b.length>0&&l.removeHelpfulFromPost(b)},removeSolvedFromPost:function(b){b.hasClass("statusteacher")?b.removeClass("statusteacher"):(b.removeClass("statusboth"),b.addClass("statusstarter")),l.redoStatus(b);var c=g.get_string("marksolved","mod_moodleoverflow");a.when(c).done(function(a){b.find(".marksolved").text(a)})},removeOtherSolved:function(a){var b=a.find(".statusteacher, .statusboth");b.length>0&&l.removeSolvedFromPost(b)},redoStatus:function(b){if(a(b).hasClass("statusboth")){var d=[{key:"teacherrating",component:"mod_moodleoverflow"},{key:"starterrating",component:"mod_moodleoverflow"},{key:"bestanswer",component:"mod_moodleoverflow"}];g.get_strings(d).then(function(d){var e=c.renderPix("status/c_circle","mod_moodleoverflow",d[0]),f=c.renderPix("status/b_box","mod_moodleoverflow",d[1]);return a.when(f,e).done(function(a,c){b.find(".status").html(a+c+d[2])}),d})}else if(a(b).hasClass("statusteacher")){var e=[{key:"teacherrating",component:"mod_moodleoverflow"},{key:"solvedanswer",component:"mod_moodleoverflow"}];g.get_strings(e).then(function(d){var e=c.renderPix("status/c_outline","mod_moodleoverflow",d[0]);return a.when(e).done(function(a){b.find(".status").html(a+d[1])}),d})}else if(a(b).hasClass("statusstarter")){var f=[{key:"starterrating",component:"mod_moodleoverflow"},{key:"helpfulanswer",component:"mod_moodleoverflow"}];g.get_strings(f).then(function(d){var e=c.renderPix("status/b_outline","mod_moodleoverflow",d[0]);return a.when(e).done(function(a){b.find(".status").html(a+d[1])}),d})}else b.find(".status").html("")}};return l});